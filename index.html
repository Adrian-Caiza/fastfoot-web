<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FastFoot - Seguridad</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        .brand-color { color: #FF5722; }
        .bg-brand { background-color: #FF5722; }
        .btn-hover:hover { background-color: #E64A19; }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4">

    <div class="bg-white p-8 rounded-lg shadow-lg max-w-md w-full text-center">
        <div class="mb-6 flex justify-center">
            <div class="rounded-full bg-orange-100 p-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 brand-color" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>
            </div>
        </div>

        <div id="loading-section">
            <p class="text-gray-500 mb-6 text-sm">Analizando enlace...</p>
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-orange-500 mx-auto"></div>
        </div>

        <div id="recovery-container" class="hidden">
            <h2 class="text-2xl font-bold mb-2 text-gray-800">Nueva Contraseña</h2>
            <p class="text-gray-500 mb-6 text-sm">Crea una nueva contraseña para tu cuenta.</p>
            
            <input type="password" id="password" placeholder="Nueva contraseña (min 6 caracteres)" 
                   class="w-full p-3 border border-gray-300 rounded mb-4 focus:outline-none focus:border-orange-500 transition">
            
            <button onclick="updatePassword()" id="submitBtn"
                    class="w-full bg-brand text-white p-3 rounded font-bold btn-hover transition duration-200">
                CAMBIAR CONTRASEÑA
            </button>
        </div>

        <div id="verified-container" class="hidden">
            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4">
                <svg class="h-8 w-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            <h2 class="text-2xl font-bold mb-2 text-gray-800">¡Email Verificado!</h2>
            <p class="text-gray-500 mb-6 text-sm">Tu cuenta ha sido confirmada correctamente.</p>
            <p class="text-orange-600 font-semibold">Ya puedes cerrar esta ventana e iniciar sesión en la App.</p>
        </div>

        <p id="message" class="mt-4 text-sm font-semibold hidden"></p>
    </div>

    <script>
        // --- CONFIGURACIÓN ---
        const supabaseUrl = 'https://mmvbwiozwwvvmyhpepdk.supabase.co'; 
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1tdmJ3aW96d3d2dm15aHBlcGRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4OTk5MTUsImV4cCI6MjA4MTQ3NTkxNX0.dvuJVNE_8SgfkD3pt-I--yDk2yyxo5UIyuxBQIINi6I';

        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        // Referencias UI
        const loader = document.getElementById('loading-section');
        const recoveryDiv = document.getElementById('recovery-container');
        const verifiedDiv = document.getElementById('verified-container');
        const msg = document.getElementById('message');

        // --- LÓGICA DE DETECCIÓN INTELIGENTE ---
        
        // 1. Función para leer parámetros de la URL (Hash o Query)
        function getUrlParam(name) {
            const urlStr = window.location.href; // Busca en toda la URL
            name = name.replace(/[\[\]]/g, '\\$&');
            const regex = new RegExp('[?&#]' + name + '(=([^&#]*)|&|#|$)');
            const results = regex.exec(urlStr);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }

        // 2. Determinar vista inicial basada en la URL (Antes de que Supabase cargue)
        function handleInitialState() {
            const type = getUrlParam('type'); // Supabase envía type=signup o type=recovery
            const error = getUrlParam('error');

            console.log("Tipo detectado en URL:", type);

            if (error) {
                showError("Enlace inválido o expirado: " + getUrlParam('error_description'));
                return;
            }

            // Si dice explícitamente recovery, mostramos recovery
            if (type === 'recovery') {
                showRecovery();
            } 
            // Si dice signup o invite, mostramos verificado
            else if (type === 'signup' || type === 'invite') {
                showVerified();
            }
            // Si no hay tipo pero hay token, esperamos al listener de Supabase...
        }

        // 3. Listener de Supabase (Para confirmar que la sesión se creó)
        supabaseClient.auth.onAuthStateChange(async (event, session) => {
            console.log("Evento Supabase:", event);

            // Si Supabase nos dice que es recovery, le creemos ciegamente
            if (event === 'PASSWORD_RECOVERY') {
                showRecovery();
            }
            // Si iniciamos sesión (por token de email o login)
            else if (event === 'SIGNED_IN' || event === 'INITIAL_SESSION') {
                // Volvemos a chequear la URL para desempatar
                const type = getUrlParam('type');
                
                if (type === 'recovery') {
                    showRecovery();
                } else {
                    // Si iniciamos sesión y NO es recovery, asumimos éxito de verificación
                    // (O si el usuario ya estaba logueado y refrescó la página)
                    showVerified();
                }
            }
        });

        // --- FUNCIONES VISUALES ---
        function showRecovery() {
            loader.style.display = 'none';
            verifiedDiv.style.display = 'none';
            recoveryDiv.style.display = 'block';
        }

        function showVerified() {
            loader.style.display = 'none';
            recoveryDiv.style.display = 'none';
            verifiedDiv.style.display = 'block';
        }

        function showError(text) {
            loader.style.display = 'none';
            msg.innerText = text;
            msg.classList.remove('hidden');
            msg.classList.add('text-red-500');
        }

        // --- LÓGICA PASSWORD ---
        async function updatePassword() {
            const password = document.getElementById('password').value;
            const btn = document.getElementById('submitBtn');

            if (password.length < 6) {
                alert("Mínimo 6 caracteres"); return;
            }
            btn.disabled = true;
            btn.innerText = "Guardando...";

            const { error } = await supabaseClient.auth.updateUser({ password: password });

            if (error) {
                msg.innerText = error.message;
                msg.classList.remove('hidden');
                msg.classList.add('text-red-500');
                btn.disabled = false;
                btn.innerText = "CAMBIAR CONTRASEÑA";
            } else {
                msg.innerText = "¡Contraseña actualizada! Vuelve a la App.";
                msg.classList.remove('text-red-500');
                msg.classList.add('text-green-600');
                msg.classList.remove('hidden');
                recoveryDiv.style.display = 'none';
                await supabaseClient.auth.signOut();
            }
        }

        // EJECUTAR CHECK INICIAL
        handleInitialState();

    </script>
</body>
</html>